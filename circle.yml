machine:
  python:
    version: 3.6.1

dependencies:
  cache_directories:
    - env/

  override:
    - pip install -U bootstrapper pip wheel
    - make
    - make setup-pyenv

test:
  override:
    - TEST_ARGS="--junit-xml=pytest.xml --cov-report=html:$CIRCLE_ARTIFACTS/coverage" make test

  post:
    - make coveralls
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - "[ -r pytest.xml ] && mv pytest.xml $CIRCLE_TEST_REPORTS/junit/ || :"

deployment:
  release:
    tag: /v\d+.\d+.\d+.*/
    commands:
      - make deploy
